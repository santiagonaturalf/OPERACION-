<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f8f9fa; }
      h2 { color: #202124; }
      p { font-size: 14px; color: #5f6368; }
      table { width: 100%; border-collapse: collapse; margin-top: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24); background-color: white; }
      th, td { border: 1px solid #ddd; padding: 8px; text-align: left; vertical-align: top; font-size: 14px; }
      th { background-color: #f2f2f2; font-weight: bold; color: #202124; padding: 12px 8px; }
      .context { font-size: 12px; color: #5f6368; line-height: 1.4; }
      .context b { color: #202124; }
      .deviation-high { color: #d93025; font-weight: bold; }
      .deviation-low { color: #1e8e3e; font-weight: bold; }
      input[type="number"] { width: 95%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
      input[type="number"]:focus { border-color: #4285f4; outline: none; box-shadow: 0 0 0 2px #d2e3fc; }
      .button-container { margin-top: 25px; text-align: right; }
      button { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: bold; }
      #approveBtn { background-color: #1a73e8; color: white; }
      #approveBtn:disabled { background-color: #9e9e9e; cursor: not-allowed; }
      #cancelBtn { background-color: #f1f3f4; color: #202124; margin-left: 10px; }

      .status-ok { background-color: #e6f4ea; }
      .status-new { background-color: #feefc3; }
      .status-anomaly { background-color: #fce8e6; }

      .margin-ok { color: #188038; font-weight: bold; }
      .margin-warn { color: #f9ab00; font-weight: bold; }
      .margin-bad { color: #d93025; font-weight: bold; }
    </style>
  </head>
  <body>
    <h2>Aprobación de Precios de Adquisición</h2>
    <p>Se muestran todos los productos procesados hoy. Revisa los precios, ajústalos si es necesario y luego guárdalos.</p>

    <table id="analysisTable">
      <thead>
        <tr>
          <th>Producto</th>
          <th>Costo Hoy (Editable)</th>
          <th>Precio Venta</th>
          <th>Margen Bruto (%)</th>
          <th>Info. Compra</th>
          <th>Desviación</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>

    <div class="button-container">
      <button id="approveBtn">Aprobar y Guardar Cambios</button>
      <button id="cancelBtn" onclick="google.script.host.close()">Cancelar</button>
    </div>

    <script>
      const analysisResults = <?!= JSON.stringify(analysisResults) ?>;

      function calculateMargin(salePrice, costPrice) {
        if (salePrice > 0) {
          return ((salePrice - costPrice) / salePrice) * 100;
        }
        return 0;
      }

      function updateMargin(index) {
        const costInput = document.getElementById(`costo-${index}`);
        const salePrice = parseFloat(costInput.dataset.salePrice);
        const newCost = parseFloat(costInput.value);
        const marginCell = document.getElementById(`margin-${index}`);

        if (!marginCell || isNaN(salePrice) || isNaN(newCost)) return;

        const newMargin = calculateMargin(salePrice, newCost);
        marginCell.textContent = newMargin.toFixed(1) + '%';

        marginCell.className = '';
        if (newMargin < 15) {
            marginCell.classList.add('margin-bad');
        } else if (newMargin < 30) {
            marginCell.classList.add('margin-warn');
        } else {
            marginCell.classList.add('margin-ok');
        }
      }

      window.onload = function() {
        const tableBody = document.getElementById('analysisTable').getElementsByTagName('tbody')[0];
        if (!analysisResults || analysisResults.length === 0) {
            document.body.innerHTML = '<h2>Análisis de Precios</h2><p>No hay nuevas adquisiciones para procesar hoy.</p>';
            return;
        }

        analysisResults.forEach((item, index) => {
          let newRow = tableBody.insertRow();
          newRow.className = 'status-' + item.status;

          newRow.insertCell(0).innerHTML = item.nombreProducto;
          newRow.insertCell(1).innerHTML = `<input type="number" id="costo-${index}" value="${item.costoHoy.toFixed(2)}" step="0.01" data-sale-price="${item.precioVenta}">`;
          newRow.insertCell(2).innerHTML = item.precioVenta > 0 ? item.precioVenta.toFixed(2) : 'N/A';

          let marginCell = newRow.insertCell(3);
          marginCell.id = `margin-${index}`;

          newRow.insertCell(4).innerHTML = `
            <div class="context">
              <b>Base:</b> ${item.productoBase}<br>
              <b>Formato:</b> ${item.formatoCompra}<br>
              <b>Proveedor:</b> ${item.proveedor}<br>
              <b>Precio Formato:</b> ${item.precioUnitarioCompra.toFixed(2)}
            </div>
          `;

          let devCell = newRow.insertCell(5);
          if (item.status === 'anomaly') {
            const devLevel = item.nivelDesviacion;
            devCell.innerHTML = `${devLevel.toFixed(2)} StdDevs`;
            devCell.className = devLevel > 0 ? 'deviation-high' : 'deviation-low';
          } else {
            devCell.innerHTML = 'N/A';
          }

          document.getElementById(`costo-${index}`).oninput = function() { updateMargin(index); };
          updateMargin(index);
        });
      };

      document.getElementById('approveBtn').addEventListener('click', function() {
        this.disabled = true;
        this.textContent = 'Guardando...';

        const finalData = analysisResults.map((item, index) => {
            const updatedCost = parseFloat(document.getElementById(`costo-${index}`).value);
            return { ...item, costoHoy: updatedCost };
        });

        google.script.run
          .withSuccessHandler(function(response) {
            alert(response);
            google.script.host.close();
          })
          .withFailureHandler(function(error) {
            alert('Error al guardar: ' + error.message);
            document.getElementById('approveBtn').disabled = false;
            document.getElementById('approveBtn').textContent = 'Aprobar y Guardar Cambios';
          })
          .commitPriceData(finalData);
      });
    </script>
  </body>
</html>
