<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #f0f2f5; color: #333; }
    .container { padding: 20px; }
    h1 { color: #1c1e21; margin-top: 0; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { padding: 12px 8px; text-align: left; border-bottom: 1px solid #ddd; }
    th { font-weight: bold; font-size: 13px; color: #606770; background-color: #f5f6f7; }
    td { font-size: 14px; vertical-align: middle; }
    tr:hover { background-color: #f5f5f5; }
    input, select {
      width: 95%;
      padding: 8px;
      font-size: 14px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    .footer-actions {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      padding: 15px 20px;
      background-color: #fff;
      border-top: 1px solid #ddd;
      text-align: right;
      box-sizing: border-box;
    }
    .button {
      padding: 10px 20px;
      font-size: 14px;
      font-weight: bold;
      border-radius: 5px;
      border: none;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    #save-btn { background-color: #1877f2; color: white; }
    #save-btn:disabled { background-color: #dcdfe3; color: #bec3c9; cursor: not-allowed; }
    #cancel-btn { background-color: #e4e6eb; color: #4b4f56; margin-left: 10px; }
    #status { margin-right: 15px; color: #606770; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Editar Borrador de Adquisiciones</h1>
    <p>Ajusta las cantidades, formatos y proveedores antes de generar la lista final y notificar.</p>
    <table id="acquisitions-table">
      <thead>
        <tr>
          <th>Producto Base</th>
          <th>Necesidad Venta</th>
          <th>Cantidad a Comprar (Sugerida)</th>
          <th>Formato de Compra</th>
          <th>Proveedor</th>
          <th>Inventario al Finalizar</th>
        </tr>
      </thead>
      <tbody>
        <!-- Las filas de datos se insertarán aquí dinámicamente -->
      </tbody>
    </table>
  </div>

  <div class="footer-actions">
      <span id="status">Cargando datos...</span>
      <button id="save-btn" class="button" disabled>Guardar y Notificar</button>
      <button id="cancel-btn" class="button" onclick="google.script.host.close()">Cancelar</button>
  </div>

  <script>
    let planData = [];
    let allSuppliers = [];
    const tableBody = document.querySelector("#acquisitions-table tbody");
    const saveBtn = document.getElementById('save-btn');
    const statusSpan = document.getElementById('status');

    window.onload = function() {
      try {
        // El servidor pasa un objeto. Se serializa a un literal de objeto JSON aquí.
        const serverData = <?!= JSON.stringify(data) ?>;
        planData = serverData.acquisitionPlan;
        allSuppliers = serverData.allSuppliers;

        // Guardamos una referencia a los objetos de formato completos en cada item del plan
        planData.forEach(item => {
          item.allFormatObjects = [...item.availableFormats]; // Copia de los objetos de formato
          item.allFormatStrings = item.availableFormats.map(f => `${f.name} (${f.size} ${f.unit})`);
          // Establecer el formato seleccionado inicial
          item.selectedFormatString = `${item.suggestedFormat.name} (${item.suggestedFormat.size} ${item.suggestedFormat.unit})`;
        });

        renderTable();
        statusSpan.textContent = 'Listo para editar.';
        saveBtn.disabled = false;

        // Event delegation for dynamic updates
        tableBody.addEventListener('input', function(e) {
          if (e.target.classList.contains('quantity-input') || e.target.classList.contains('format-select')) {
            const row = e.target.closest('tr');
            if (!row) return;

            const index = parseInt(row.getAttribute('data-index'), 10);
            const item = planData[index];
            
            const quantity = row.querySelector('.quantity-input').value;
            const formatString = row.querySelector('.format-select').value;
            
            const finalInventory = calculateFinalInventory(item, quantity, formatString);
            
            const finalInventoryCell = row.querySelector('.final-inventory');
            if (finalInventoryCell) {
              finalInventoryCell.textContent = `${finalInventory} ${item.unit}`;
            }
          }
        });

      } catch (e) {
        console.error("Error al parsear o procesar los datos iniciales:", e);
        statusSpan.textContent = 'Error al cargar los datos.';
        alert("No se pudieron cargar los datos para el editor. Error: " + e.message);
      }
    };

    function calculateFinalInventory(item, quantity, formatString) {
      const selectedFormat = item.allFormatObjects.find(f => `${f.name} (${f.size} ${f.unit})` === formatString);
      const formatSize = selectedFormat ? selectedFormat.size : 0;
      const purchasedAmount = (parseFloat(quantity) || 0) * formatSize;
      const finalInventory = (item.currentInventory || 0) + purchasedAmount - (parseFloat(item.totalNeed) || 0);
      return finalInventory.toFixed(2); // Redondear a 2 decimales
    }

    function renderTable() {
      tableBody.innerHTML = ''; // Limpiar la tabla antes de renderizar
      planData.forEach((item, index) => {
        const row = document.createElement('tr');
        row.setAttribute('data-index', index);

        const finalInventory = calculateFinalInventory(item, item.suggestedQty, item.selectedFormatString);

        // Crear las celdas de la fila
        row.innerHTML = `
          <td>${item.productName}</td>
          <td>${item.totalNeed} ${item.unit}</td>
          <td><input type="number" class="quantity-input" value="${item.suggestedQty}" min="0" step="any"></td>
          <td><select class="format-select">${createOptions(item.allFormatStrings, item.selectedFormatString)}</select></td>
          <td><select class="supplier-select">${createOptions(allSuppliers, item.supplier)}</select></td>
          <td class="final-inventory">${finalInventory} ${item.unit}</td>
        `;
        tableBody.appendChild(row);
      });
    }

    function createOptions(optionsArray, selectedValue) {
      return optionsArray.map(option =>
        `<option value="${option}" ${option === selectedValue ? 'selected' : ''}>${option}</option>`
      ).join('');
    }

    saveBtn.addEventListener('click', function() {
      setLoadingState(true, 'Guardando cambios...');

      const finalPlan = [];
      const rows = tableBody.querySelectorAll('tr');

      rows.forEach(row => {
        const index = parseInt(row.getAttribute('data-index'), 10);
        const originalItem = planData[index];

        const quantity = row.querySelector('.quantity-input').value;
        const selectedFormatString = row.querySelector('.format-select').value;
        const supplier = row.querySelector('.supplier-select').value;

        finalPlan.push({
          ...originalItem, // Copia todas las propiedades originales (totalNeed, unit, etc.)
          quantity: quantity,
          selectedFormatString: selectedFormatString,
          supplier: supplier,
        });
      });

      google.script.run
        .withSuccessHandler(handleSaveSuccess)
        .withFailureHandler(handleError)
        .saveAcquisitions(finalPlan);
    });

    function handleSaveSuccess(response) {
      alert(response.message);
      setLoadingState(true, 'Guardado. Abriendo panel de notificación...');
      // Iniciar el siguiente paso del flujo de trabajo
      google.script.run
        .withSuccessHandler(() => google.script.host.close())
        .withFailureHandler(handleError)
        .startNotificationProcess();
    }

    function handleError(error) {
      setLoadingState(false, `Error: ${error.message}`);
      alert(`Ocurrió un error: ${error.message}`);
    }

    function setLoadingState(isLoading, message) {
      saveBtn.disabled = isLoading;
      statusSpan.textContent = message;
    }
  </script>
</body>
</html>
